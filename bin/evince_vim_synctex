#!/bin/sh

GVIM_SERVERNAME=$1
PDFFILE="$2"
EDITORCMD="gvim --servername $GVIM_SERVERNAME --remote-send '<Esc>:call foreground()<CR>' --remote-silent '+%l<Enter>zz' %f"
# Highlight matched column
#EDITORCMD="gvim --servername '`basename "$1" .pdf`' --remote-silent '+%l<Enter>:match Search /\%%ll/' %f"

if [ $# -eq 0 ]; then
	echo -e "usage: $0 <vim-servername> <pdf-file>"
	exit 0;
fi

[ -f "$PDFFILE" ] || \
	(echo "no such pdf file" && exit 1);
[ -f "${PDFFILE%%.pdf}.synctex.gz" ] || \
	(echo "missing file ${PDFFILE%%.pdf}.synctex.gz" && exit 1);

evince_backward_search "$PDFFILE" "$EDITORCMD"&
BACKWARD_SEARCH_PID=$!
echo "Backward search daemon running with pid $BACKWARD_SEARCH_PID"

echo "Starting evince and waiting …"
/usr/bin/evince "$PDFFILE"

if [ "$BACKWARD_SEARCH_PID" ];then
	echo "Killing backward search daemon $BACKWARD_SEARCH_PID …"
	kill $BACKWARD_SEARCH_PID
fi
