#!/bin/bash
#
# TODO: allow spaces in filenames, tex has problems with it

COMPILE_PATH=/tmp

if [ $# -eq 0 ]; then
	echo -e "usage: booklet [-p <pages>] [-s <pages-per-signature>]\n" \
			"              [-o <output-pdf>] [-h <trim-horiz>]\n" \
			"              [-v <trim-vert>] <input-pdf>"
	exit 0;
fi

PAGES="pages=-"
SIGNATURE="booklet=true"
TRIMH="0"
TRIMV="0"

while getopts "p:s:o:h:v:" opt; do
	case "$opt" in
		p) PAGES="pages={$OPTARG}"
			;;
		s) SIGNATURE="signature=$OPTARG"
			;;
		o) BOOKLET_TARGET_NAME="${OPTARG%.*}"
			;;
		h) TRIMH="${OPTARG}"
			;;
		v) TRIMV="${OPTARG}"
			;;
	esac
done
shift $((OPTIND-1))

export BOOKLET_SOURCE="`realpath $@`"

if [ -z $BOOKLET_TARGET_NAME ]; then
	export BOOKLET_TARGET_NAME="${@%.*}-booklet"
fi


echo "\\documentclass{article} \
\\usepackage[a4paper]{geometry} \
\\usepackage[pdftex]{color,graphicx,epsfig} \
\\usepackage{pdfpages} \
\\begin{document} \
\\includepdf[${PAGES},${SIGNATURE},landscape,trim=${TRIMH}cm ${TRIMV}cm ${TRIMH}cm ${TRIMV}cm]{${BOOKLET_SOURCE}} \
\\end{document}" > "${COMPILE_PATH}/${BOOKLET_TARGET_NAME}.tex"

#\\includepdf[${PAGES},${SIGNATURE},landscape,delta=0 2.5cm,pagetemplate=5]{${BOOKLET_SOURCE}} \

cd ${COMPILE_PATH}
pdflatex ${BOOKLET_TARGET_NAME}.tex
cd -
mv "${COMPILE_PATH}/${BOOKLET_TARGET_NAME}.pdf" ./
rm -f "${COMPILE_PATH}/${BOOKLET_TARGET_NAME}.{pdf,tex,aux,log}"


